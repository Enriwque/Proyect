import request from 'supertest';
import express from 'express';
import { fetchChapters, fetchChapter, updateChapter, postChapter, deleteChapter } from '../../controllers/chapters.js';
import jwt from 'jsonwebtoken';

const app = express();
app.use(express.json());
app.get('/chapters', fetchChapters);
app.get('/chapters/:id', fetchChapter);
app.put('/chapters/:token/:id', updateChapter);
app.post('/chapters/:token', postChapter);
app.delete('/chapters/:token/:id', deleteChapter);

jest.mock('../../models/chapters.js', () => jest.fn());
jest.mock('../../services/index.js', () => ({
    ChapterEntry: {
        find: jest.fn(),
        findOne: jest.fn(),
        countDocuments: jest.fn(),
        deleteOne: jest.fn(),
        save: jest.fn(),
    },
}));

describe('Chapters Controller', () => {
    let token;

    beforeAll(() => {
        token = jwt.sign({ role: 'admin' }, process.env.JWT_SECRET);
    });

    test('fetchChapters should return chapters', async () => {
        const chapters = [{ id: 1, title: 'Chapter 1' }];
        capitulos.mockResolvedValue(chapters);

        const response = await request(app).get('/chapters');
        expect(response.status).toBe(200);
        expect(response.body).toEqual(chapters);
    });

    test('fetchChapter should return a chapter', async () => {
        const chapter = { id: 1, title: 'Chapter 1' };
        ChapterEntry.find.mockResolvedValue(chapter);

        const response = await request(app).get('/chapters/1');
        expect(response.status).toBe(200);
        expect(response.body).toEqual(chapter);
    });

    test('updateChapter should update a chapter', async () => {
        const chapter = { id: 1, title: 'Chapter 1' };
        ChapterEntry.findOne.mockResolvedValue(chapter);
        ChapterEntry.save.mockResolvedValue(chapter);

        const response = await request(app)
            .put(`/chapters/${token}/1`)
            .send({ title: 'Updated Chapter 1' });

        expect(response.status).toBe(201);
        expect(response.body.title).toBe('Updated Chapter 1');
    });

    test('postChapter should create a new chapter', async () => {
        ChapterEntry.countDocuments.mockResolvedValue(1);
        ChapterEntry.save.mockResolvedValue({ id: 2, title: 'New Chapter' });

        const response = await request(app)
            .post(`/chapters/${token}`)
            .send({ title: 'New Chapter' });

        expect(response.status).toBe(201);
        expect(response.body.title).toBe('New Chapter');
    });

    test('deleteChapter should delete a chapter', async () => {
        ChapterEntry.deleteOne.mockResolvedValue({ deletedCount: 1 });

        const response = await request(app).delete(`/chapters/${token}/1`);
        expect(response.status).toBe(200);
        expect(response.text).toBe('Chapter 1 deleted');
    });
});import request from 'supertest';